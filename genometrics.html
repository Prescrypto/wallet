<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Sequentia Wallet</title>
  <link rel="stylesheet" type="text/css" href="css/genometrics.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/uikit/3.0.0-rc.5/css/uikit.min.css" />
  <link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,700,900" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/uikit/3.0.0-rc.5/js/uikit.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/uikit/3.0.0-rc.5/js/uikit-icons.min.js"></script>
</head>
<body>
  <!-- Main menu -->
  <nav class="uk-navbar-container" uk-navbar="boundary-align: true; align: right;">
    <div class="uk-navbar-left">
      <ul class="uk-navbar-nav">
        <li><a class="uk-navbar-item uk-logo" href="index.html"> SequentiaWallet </a></li>
      </ul>
    </div>
    <div class="uk-navbar-right">
      <ul class="uk-navbar-nav">
        <li>
          <a class="uk-navbar-toggle" uk-navbar-toggle-icon href=""></a>
          <div class="uk-navbar-dropdown">
            <ul class="uk-nav uk-navbar-dropdown-nav">
              <li id="menu_item"><a href="https://genobank.herokuapp.com/">Go to Navigator</a></li>
              <li id="menu_item">
                <form class="uk-search uk-search-default">
                  <span class="uk-search-icon-flip" uk-search-icon></span>
                  <input class="uk-search-input" type="search" placeholder="Search...">
                </form>
              </li>
              <li id="menu_item"><a href="#">Contact</a></li>
            </ul>
          </div>
        </li>
      </ul>
    </div>
  </nav>
  <!-- Closing Main menu -->

  <!-- BEGIN Aside pub and private keys -->
  <aside style="display:none;">
    <textarea id="pub_key"></textarea>
    <textarea id="priv_key"></textarea>
  </aside>
  <!-- END Aside pub and private keys -->

  <div class="uk-grid-medium" align="center">
    <h2>Your Genomics</h2>
    <div class="uk-child-width-1-1@s" uk-grid>
      <div>
        <ul id="genocontent" uk-accordion="collapsible: false">
          <!-- Initial Items -->
        </ul>
        <br>
      </div>
    </div>

    <!-- Closing Menu Add Genometrics-->
    <!-- Menu Create form -->
    <div>
      <button class="uk-button uk-button-default" type="button" style="font-weight: 700;background-color: white">Create</button>
      <div id='fields' uk-dropdown>
        <div id="formcontent">
          <div id="inputGroup1" class="uk-nav uk-dropdown-nav">
            <form id="inputGroup" class="uk-grid-small" uk-grid action="" method="post">
              <table id="table_fields" class="uk-table uk-table-responsive">
                <thead>
                  <tr>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td>
                      <input class="uk-input" type="text" placeholder=" Country" required>
                    </td>
                    <td>
                      <input class="uk-input" type="number" placeholder="Percentage (Only numbers)" required>
                    </td>
                  </tr>
                </tbody>
              </table>
            </form>
          </div>
        </div>
        <div id="formButtons">
          <button name="add_field" id="add_field" class="uk-button uk-button-default" type="button" uk-icon="icon:plus"> Add New  </button>
          <button name="remove_field" id="remove_field" class="uk-button uk-button-default" type="button" uk-close> Remove  </button>
          <button id="send_data" class="uk-button uk-button-default" type="submit"> Submit </button>
        </div>
      </div>
      <!-- Closing create form-->
      <button class="uk-button uk-button-default" type="button" style="font-weight: 700;background-color: #A3A0FB;color:#fff">Receive</button>
    </div>


  </div>

  <br>
  <script src="js/localforage.min.js"></script>
  <script src="https://code.jquery.com/jquery-1.8.3.min.js"></script>
  <script src="js/jsencrypt.js"></script>
  <script src="js/jsrsasign-all-min.js"></script>
  <script src="js/underscore-min.js"></script>
  <script src="js/wallet.js"></script>
  <script>
    // Tx template
    var tx_template = '<a id="genome" href="genodetails.html?tx_id=<%= tx.hash_id %>"> \
        <div class="uk-margin"> \
          <div class="uk-card uk-card-default uk-card-body uk-card-small"> \
            <div class="uk-column-1-2"> \
              <img align="center" src="media/dna-icon.png"> \
              <p id="geno_p"><span id="genotitle"><%= tx.timestamp %></span><br><%= tx.hash_id %></p> \
            </div> \
          </div> \
        </div> \
        </a>'

            var tx_acc_template_unselected = '<li>\
                <a class="uk-accordion-title uk-card uk-card-default uk-card-small" id="genome" href="#" style="font-weight:50;background-color: #d7d8d9;color:#000" >\
                 <%= tx.hash_id %> </a>\
                <div class="uk-accordion-content" aria-hidden="false" hidden="">\
                  <div class="uk-card uk-card-default uk-card-body uk-card-small"> \
                    <div class="uk-column-1-2"> \
                      <img align="center" src="media/dna-icon.png" href="genodetails.html?tx_id=<%= tx.id %>" > \
                      <a id="geno_p" href="genodetails.html?tx_id=<%= tx.hash_id %>"><span id="genotitle"><%= tx.timestamp %></span><br><%= tx.hash_id %></a> \
                    </div> \
                  </div> \
                </div>\
            </li>'

    var tx_acc_template = '<li>\
                <a class="uk-accordion-title uk-container uk-container-xsmall" id="genome" href="#" style="text-align:center; font-size:100%; font-weight:200;background-color: #d7d8d9;color:#000" >\
                 <%= tx.hash_id %> </a>\
                <div class="uk-accordion-content" aria-hidden="false" hidden="">\
                  <div class="uk-card uk-card-default uk-card-body uk-card-small"> \
                    <div class="uk-column-1-2"> \
                      <img align="center" src="media/dna-icon.png" href="genodetails.html?tx_id=<%= tx.id %>" > \
                      <a id="geno_p" href="genodetails.html?tx_id=<%= tx.hash_id %>" style="text-align:center;"><span id="genotitle"><%= tx.timestamp %></span><br><%= tx.hash_id %></a> \
                    </div> \
                  </div>\
                </div>\
            </li>'

    function add_tx_markup(data){
      // A tx data provided compile and render item
      $('#non-item').remove();
      var _template = _.template(tx_acc_template);
      var _compiled = _template({"tx":data});
      $('#genocontent').append(_compiled);
    }

    $(document).ready(function() {
      (function ($, localforage){
        function setKeys(){
          // Set the keys on textarea onload page
          localforage.getItem('privatekey', function(err, value){
            $('#priv_key').val(value);
          });
          localforage.getItem('publickey', function(err, value){
            $('#pub_key').val(value);
            var encrypt = new JSEncrypt();
            encrypt.setPublicKey(value);
            value_b64 = encrypt.getPublicKeyB64();
            // Get Txs when load page!
            var list_rx = [];
            var pubkey_uri= encodeURIComponent(value_b64).replace(/'/g,"%27").replace(/"/g,"%22");
            var url = window.baseurl +"api/v1/rx-endpoint/?public_key=" + pubkey_uri;
            $.get(url, function(data) {
              // Get data from server
              if (data.results.length == 0){
                // Render no tx label
                $("#genocontent").html("<span id='non-item'>Without Txs :( Start creating new one!</span>");
              }else{
                data.results.forEach(function(item) {
                  // Add tx to template
                  add_tx_markup(item);
                });
              }
              // Finish get
            });
          });

        };
        setKeys();
      })($, localforage);
    });
    // Functions
    function add_field(){
      // Add a field in table
      $('#table_fields tr:last').after('\
        <tr>\
          <td>\
            <input class="uk-input" type="text" placeholder=" Country" required>\
          </td>\
          <td>\
            <input class="uk-input" type="number" placeholder="   Percentage (Only numbers)" required>\
          </td>\
        </tr>');
    }

    function sign(msg, priv_key, hash_alg){
      //Create a signature of payload
      var rsa = new RSAKey();
      rsa.readPrivateKeyFromPEMString(priv_key);
      var sign_msg = rsa.sign(msg, hash_alg);
      return sign_msg;
    }


    function remove_field(){
      // Remove a field in table
      $('#table_fields tr:last').remove();
    }

    function read_input(){
      // Read all the inputs in form and make a list
      var list_input = [];
      $.each($('#table_fields td').children(), function(){
        value_input = $(this).val();
        list_input.push(value_input);
      });
      return list_input;
    }

    function create_payload(){
      // Make data and make a POST

      // Make data
      var index = 1;
      var data_payload = [];
      var list_input = read_input();
      var payload = new Object();

      for (index; index<list_input.length; index++){
        if (index%2){
          data_payload.push({"country_name":list_input[index-1],"percentage":list_input[index]});
        }
      }

      // Encrypt data
      var encrypt = new JSEncrypt();
      var index_encrypt = 0;

      encrypt.setPublicKey($("#pub_key").val());
      for (index_encrypt; index_encrypt<data_payload.length; index_encrypt++){
        data_payload[index_encrypt].country_name = encrypt.encrypt(data_payload[index_encrypt].country_name);
        data_payload[index_encrypt].percentage = encrypt.encrypt(data_payload[index_encrypt].percentage);
      }

      // Make payload
      var today = new Date();
      var times = today.toISOString();

      payload.timestamp = times;
      payload.public_key = encrypt.getPublicKeyB64();
      payload.data = JSON.stringify(data_payload);
      payload.location = "Mexico";

      var msg = payload.data;
      var hash_alg = 'sha1';
      var prk = $('#priv_key').val();
      payload.signature = sign(msg, prk, hash_alg);


      // Make POST
      var posting = $.post(window.baseurl + "api/v1/rx-endpoint/",
                      payload);

      posting.done(function(data, text_status){
        console.log(text_status);
        // reload page to see new items
        location.reload();
      });
      posting.fail(function(xhr, textStatus, errorThrown){
        console.log(xhr.responseText);
      });
      posting.always(function(){
        // Finish POST!
      });
    }

    // Events
    $('#add_field').on('click', function(){
      add_field();
    });

    $('#remove_field').on('click',function(){
      var length_table = $('#table_fields tr').length;
      if(length_table >= 3){
        remove_field();
      }
    });

    $('#send_data').one('click', function(){
      create_payload();
      $(this).attr("disabled","disabled");
    });
  </script>
</body>
</html>
