<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Sequentia Wallet</title>
  <link rel="stylesheet" type="text/css" href="css/sequentiawallet.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/uikit/3.0.0-rc.5/css/uikit.min.css" />
  <link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,700,900" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/uikit/3.0.0-rc.5/js/uikit.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/uikit/3.0.0-rc.5/js/uikit-icons.min.js"></script>
</head>
<body>
  <!-- Main menu -->
  <nav class="uk-navbar-container" uk-navbar="boundary-align: true; align: right;">
    <div class="uk-navbar-left">
      <ul class="uk-navbar-nav">
        <li><a class="uk-navbar-item uk-logo" href="index.html"> SequentiaWallet </a></li>
      </ul>
    </div>
    <div class="uk-navbar-right">
      <ul class="uk-navbar-nav">
        <li>
          <a class="uk-navbar-toggle" uk-navbar-toggle-icon href=""></a>
          <div class="uk-navbar-dropdown">
            <ul class="uk-nav uk-navbar-dropdown-nav">
              <li id="menu_item"><a href="https://genobank.herokuapp.com/">Go to Navigator</a></li>
              <li id="menu_item">
                <form class="uk-search uk-search-default">
                  <span class="uk-search-icon-flip" uk-search-icon></span>
                  <input class="uk-search-input" type="search" placeholder="Search...">
                </form>
              </li>
              <li id="menu_item"><a href="#">Contact</a></li>
            </ul>
          </div>
        </li>
      </ul>
    </div>
  </nav>
  <!-- Closing Main menu -->

<div class="uk-grid-medium" align="center">
  <form class="uk-form-horizontal uk-margin-large">
    <div class="uk-margin">
      <label class="uk-form-label" for="form-horizontal-text">Private Key</label>
        <div class="uk-form-controls">
          <textarea id="privkey" name="privkey" class="uk-input" type="text" placeholder="Generate keys"></textarea>
        </div>       
    </div>
    <div class="uk-margin">
      <label class="uk-form-label" for="form-horizontal-text">Public Key</label>
        <div class="uk-form-controls">
          <textarea id="pubkey" name="pubkey" class="uk-input" type="text" placeholder="Generate keys"></textarea>
        </div>       
    </div>
    <div class="uk-margin">
      <label class="uk-form-label" for="form-horizontal-text">Pin Code</label>
        <div class="uk-form-controls">
          <input id="pin_code" name="pin_code" class="uk-input" type="text" maxlength="4" placeholder="Enter four digits and remember not to forget this PIN" required />
          <a style="font-size:12px;" class="uk-margin-small uk-button uk-button-primary uk-button-small" id="download_keys"> Save Keys and Next </a>
        </div>
    </div>
  </form>
</div>

<script src="js/localforage.min.js"></script>
<script src="https://code.jquery.com/jquery-1.8.3.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/3.1.2/components/core-min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/3.1.2/components/sha256.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/3.1.2/rollups/aes.js"></script>
<script src="js/jsencrypt.js"></script>
<script src="js/wallet.js"></script>
<script>
    $(document).ready(function() {
      (function ($, localforage){
          function setKeys(){
          // Get the keys from localforage
          localforage.getItem('privatekey', function(err, value){
            $('#privkey').val(value);
          });
          localforage.getItem('publickey', function(err, value){
            $('#pubkey').val(value);
          });
        };
        setKeys();
      })($, localforage);
    });

    //Functions
    function verify_lenght(field){
      //This method verify if length of a fields is empty 
      if (field.length == 4){
        return true
      }else {
        alert("ERROR. Please enter a pin from four digits; Please try again.");
        return false
      }
    }


    function hash_string(){
      //This method calculate hash for the  value from pin
      var pin = CryptoJS.SHA256($('#pin_code').val());
      var pin_hash = pin.toString(CryptoJS.enc.b64);  
      return pin_hash
    }
    
    function save_encrypt_privkey(){
      //Encrypt private key and save in localforage
      var privatekey = $('#privkey').val();
      //Encrypt private key
      var encrypt = CryptoJS.AES.encrypt(privatekey, hash_string());
      var encrypt_b64 =  encrypt.toString(CryptoJS.enc.b64);
      //Save encrypt private key in localforage
      localforage.setItem('privatekey', encrypt_b64).then(function(value){
        $('#privkey').val(value);
        console.log("Success Generated Keys!");
        window.open("./genometrics.html","_self");  
      }).catch(function(e){
        console.log(e);
      });
    }

    function download_file(){
      //This method download keys files
      //Read keys
      var privatekey = $('#privkey').val();
      var publickey = $('#pubkey').val();
      
      //Make a list for create the download link  
      var files = [privatekey, publickey]
      var names_files = ["Pivate_Key.pem", "Public_Key.pem"]

      for (var i=0; i<files.length; i++){
        //Create a label type a
        var link = document.createElement("a");
        // Add attributes to label type a
        link.download = names_files[i]
        link.href = 'data:application/octet-stream,'+ encodeURIComponent(files[i]);
        link.click();
      }
    }

    //Events
    $('#download_keys').click(function(){
      if (verify_lenght($('#pin_code').val())){
        download_file();
        save_encrypt_privkey();    
      }
    });
    
    //Validation for Pin code
    $(function(){
      $('#pin_code').keypress(function(e) {
        if(isNaN(this.value + String.fromCharCode(e.charCode))) 
          return false;
      })
    });


</script>
</body>
</html>
