<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Sequentia Wallet</title>
  <link rel="stylesheet" type="text/css" href="css/genometrics.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/uikit/3.0.0-rc.5/css/uikit.min.css" />
  <link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,700,900" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/uikit/3.0.0-rc.5/js/uikit.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/uikit/3.0.0-rc.5/js/uikit-icons.min.js"></script>
  <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
</head>
<body>
  <!-- Main menu -->
  <nav class="uk-navbar-container" uk-navbar="boundary-align: true; align: right;">
    <div class="uk-navbar-left">
      <ul class="uk-navbar-nav">
        <li><a class="uk-navbar-item uk-logo" href="index.html"> SequentiaWallet </a></li>
      </ul>
    </div>
    <div class="uk-navbar-right">
      <ul class="uk-navbar-nav">
        <li>
          <a class="uk-navbar-toggle" uk-navbar-toggle-icon href=""></a>
          <div class="uk-navbar-dropdown">
            <ul class="uk-nav uk-navbar-dropdown-nav">
              <li id="menu_item"><a href="https://genobank.herokuapp.com/">Go to Navigator</a></li>
              <li id="menu_item">
                <form class="uk-search uk-search-default">
                  <span class="uk-search-icon-flip" uk-search-icon></span>
                  <input class="uk-search-input" type="search" placeholder="Search...">
                </form>
              </li>
              <li id="menu_item"><a href="#">Contact</a></li>
            </ul>
          </div>
        </li>
      </ul>
    </div>
  </nav>
  <!-- Closing Main menu -->

  <!-- Aside pub and private keys -->
  <aside style="display:none;">
    <textarea id="pub_key"></textarea>
    <textarea id="priv_key"></textarea>
  </aside>

  <!-- Aside pub and private keys -->

<div class="uk-child-width-expand@s" uk-grid>
  <div class="uk-grid-item-match">
    <div class="uk-child-width-1-2 uk-card uk-card-default uk-card-body">
      <div class="uk-inline" style="width: 100%">
        <button id="decrypt" class="uk-button uk-button-default" style="font-weight: 700;background-color: white">Decrypt</button>
        <!-- Transfer Data button calling modal-->
        <button id="transferaction" name="transferaction" class="uk-button uk-button-default" uk-toggle="target: #modal-transact" style="font-weight: 700;background-color: #4AD991; color:#fff;">Transfer Data</button>
        <a id="backbtn" class="uk-button uk-button-default" id="whitebutton" href="genometrics.html">Back</a>
        <!-- This is Transfer Data Modal-->
        <div id="modal-transact" uk-modal>
            <div class="uk-modal-dialog uk-modal-body">
                <h2 class="uk-modal-title">Transfer your genomic Data</h2>
                <form class="uk-form-stacked">
                  <div id="alert"></div>
                  <div class="uk-margin">
                    <label class="uk-form-label" for="form-stacked-text">To: </label>
                    <div class="uk-form-controls">
                      <textarea id="newpubkey" name="newpubkey" class="uk-input" type="text" placeholder="Paste Public key" onchange="validate_transfer()" required></textarea>
                      <p id="message">Or scan Qr Code with your WebCam</p>
                      <div style="width:100%;height:150px" id="reader"></div>
                        <div class="js-upload uk-placeholder uk-text-center">
                          <span uk-icon="icon: cloud-upload"></span>
                          <span class="uk-text-middle">Attach your PUBLIC Key by dropping it here or</span>
                          <div uk-form-custom>
                            <input id="pubkey_file" type="file">
                            <span id="upload_link" class="uk-link">Select your PUBLIC Key from computer</span>
                          </div>
                        </div>
                    </div>
                  </div>
                  <div class="uk-margin">
                    <label class="uk-form-label" for="form-text-area">Memo: </label>
                    <textarea id="memo" name="memo" class="uk-textarea" rows="5" placeholder=""></textarea>
                  </div>
                  <div class="uk-margin">
                    <label class="uk-form-label" for="form-pin">Pin: </label>
                    <div id="form-pin" class="uk-inline">
                      <span class="uk-form-icon uk-form-icon-flip" uk-icon="icon: lock"></span>
                      <input class="uk-input" type="number" name="pin" id="pin" required>
                    </div>
                  </div>
                  <div id="transfer_button">
                    <button id="transferdata"  class="uk-button uk-button-default" style="font-weight: 700;background-color: #fff; color:#3C3C3C;" disabled> Transfer </button>
                  </div>
                </form>
            </div>
        </div>
      </div>
      <h3>Ancestry</h3>
      <div style="width:100%">
        <label id="hash_id_label">Hash Id: </label>
      </div>
      <h5 style="width:100%;"><a id="tx_link" href="#" target="_blank"><img style="height:30px;" src="media/navigator.svg"> Show on Navigator</a></h5>
      <table id="tx_table" class="uk-table uk-table-divider">
      	<thead>
          <tr>
            <th><span id="data1">Data 1</span></th>
            <th><span id="data2">Data 2</span></th>
          </tr>
      	</thead>
      	<tbody id="tx_table_content">
          <!-- Render here tx data -->
        </tbody>
    </table>
      <div id="readable_status" >
        <!-- Status of the Transaction-->
      </div>
    </div>
  </div>

  <div class="uk-child-width-1 uk-card uk-card-default uk-card-body">
    <div id="regions_div" style="width: 100%;"></div>
    <div class="uk-card uk-card-default uk-card-body">
      <div id="piechart" style="width: 100%;"></div>
    </div>
  </div>
</div>

  <script src="js/localforage.min.js"></script>
  <script src="https://code.jquery.com/jquery-1.8.3.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/3.1.2/components/core-min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/3.1.2/components/sha256.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/3.1.2/rollups/aes.js"></script>
  <script src="js/jsencrypt.js"></script>
  <script src="js/jsrsasign-all-min.js"></script>
  <script src="js/underscore-min.js"></script>
  <script src="js/wallet.js"></script>
  <script scr="js/jquery.js"></script>
  <script scr="js/jsqrcode-combined.min.js"></script>
  <script scr="js/html5-qrcode.min.js"></script>
  <script>
  // Global variables
  var data_country = null;
  var list_decrypt = [];
  google.charts.load('current', {
    'packages':['geochart'],
    'mapsApiKey': 'AIzaSyD-9tSrke72PouQMnMX-a7eZSW0jkFMBWY'
    });
  google.charts.load('current', {'packages':['corechart']});

  var tx_data_template = '<tr> \
      <td><%= data.country_name %></td> \
      <td><%= data.percentage %></td> \
      </tr>'

  $(document).ready(function() {
    var searchParams = new URLSearchParams(window.location.search);

    if(searchParams.has("hash_id")){
            var txid = searchParams.get('hash_id');
            $('#hash_id_label').append('<pre>'+txid+'</pre>');
            $('#tx_link').attr("href", 'http://127.0.0.1:8000/?hash_id='+txid);
    }
  });

  // Functions
  function validate_key(key_id){
    // Verify if the field pubkey is empty
    if ($(key_id).val().length===0){
      return false
    }else{
      return true
    }
  }

  function sign(msg, priv_key, hash_alg){
    //Create a signature of payload
    var rsa = new RSAKey();
    rsa.readPrivateKeyFromPEMString(priv_key);
    var sign_msg = rsa.sign(msg, hash_alg);
    return sign_msg;
  }

  function validate_pin(pin){
    if (!/^([0-9])*$/.test(pin)){
      return false
    }else{
      return true
    }
  }

  function hash_string(value){
  //This method calculate hash for the  value from pin
  var pin = CryptoJS.SHA256(value);
  var pin_hash = pin.toString(CryptoJS.enc.b64);  
  return pin_hash
  }

  function validate_transfer(){
    var transfer_button = '<button onclick="transfer_data()" id="transferdata"  class="uk-button uk-button-default" style="font-weight: 700;background-color: #3C3C3C; color:#fff;"> Transfer </button>';
    var transfer_button_disabled = '<button onclick="transfer_data()" id="transferdata"  class="uk-button uk-button-default" style="font-weight: 700;background-color: #fff; color:#3C3C3C;" disabled> Transfer </button>';

    var alert_key = '<div  class="uk-alert-danger" uk-alert>\
      <a class="uk-alert-close" uk-close></a>\
      <p id="alert">Error. You have entered invalid key; Please try again.</p>\
      </div>';

      if (validate_key("#newpubkey")){
        console.log("Valid Key");
        $('#transfer_button').html(transfer_button);

      }else{
        $('#transfer_button').html(transfer_button_disabled);
        $('#alert').html(alert_key);
      }
  }

  function transfer_data(){
    //transfer data to the new owner
     var alert_not_found = '<div  class="uk-alert-danger" uk-alert>\
        <a class="uk-alert-close" uk-close></a>\
        <p id="alert">Error. No Public or Private key found.</p>\
        </div>';

      var alert_fail = '<div  class="uk-alert-danger" uk-alert>\
        <a class="uk-alert-close" uk-close></a>\
        <p id="alert">Error. Transference failed.</p>\
        </div>';

      var index = 1;
      var data_payload = [];
      var payload = new Object();
      var form_pin = ($('#pin').val()).toString();
      var form_memo = $('#memo').val();

      if (validate_key("#newpubkey") && validate_key("#priv_key")){
        for (index; index<list_decrypt.length; index++){
          var index2 = 0
            var templist = list_decrypt[index]
            data_payload.push({"country_name":templist[0],"percentage":templist[1]});
        }
        // Encrypt data
        var encrypt = new JSEncrypt();
        var index_encrypt = 0;
        var new_pub_key = $("#newpubkey").val();

        encrypt.setPublicKey(new_pub_key);
        for (index_encrypt; index_encrypt<data_payload.length; index_encrypt++){
          data_payload[index_encrypt].country_name = encrypt.encrypt(data_payload[index_encrypt].country_name);
          data_payload[index_encrypt].percentage = encrypt.encrypt(data_payload[index_encrypt].percentage.toString());
        }

        var searchParams = new URLSearchParams(window.location.search);

        if(searchParams.has("hash_id")){
          var txid = searchParams.get('hash_id');
          payload.previous_hash = txid;
        }
        if(form_memo.length > 0){
          payload.memo = encrypt.encrypt(form_memo);
        }

        var prk = $('#priv_key').val();
        var privkey = null;
        var pin_flag = true;

        while (pin_flag){
          if(form_pin.length == 4){
            var privkey_decrypt = CryptoJS.AES.decrypt(prk, hash_string(form_pin));
            try{
              privkey = privkey_decrypt.toString(CryptoJS.enc.Utf8);
              pin_flag = false;
            }catch(err){
              alert("PIN CODE invalid, try again.");
              console.log(err);
              return; 
            } 
          }else{
            alert("PIN CODE invalid. Please enter a PIN with four digits, try again.");
            return;
          }
        }   

        // Make payload
        var today = new Date();
        var times = today.toISOString();

        payload.timestamp = times;
        payload.public_key = encrypt.getPublicKeyB64();
        payload.data = JSON.stringify(data_payload);
        payload.location = "Mexico";

        var msg = payload.data;
        var hash_alg = 'sha1';

        payload.signature = sign(msg, privkey, hash_alg);

        // Make POST
        console.log("Payload Data: ");
        console.log(payload);
        var posting = $.post(window.baseurl + "api/v1/rx-endpoint/", payload);

        posting.done(function(data, text_status){
          console.log("Transfer success!");
          console.log(data);
          window.open("./genometrics.html", "_self");
        });

        posting.fail(function(xhr, textStatus, errorThrown){
          console.log("Transfer has been failed");
          $('#alert').html(alert_fail);
        });
        posting.always(function(){
          // Finish POST!
          console.log("Finish Transfer!");
        });

      }
      else{
         console.log("No Public Key found");
          $('#alert').html(alert_not_found);
          $('#newpubkey').val('');
          document.getElementById("transferdata").disabled = true;
      }

  }

  function read_pubkey_file(e) {
    // Variable
    var file = e.target.files[0];

    //Small Validation
    if (!file) {
      return;
    }

    //Read file
    var read = new FileReader();
    read.onload = function(e) {
      var content = e.target.result;
      console.log('file readed', content);
      $("#newpubkey").val(content);
      validate_transfer();
    };
    read.readAsText(file);

  }
  function add_tx_markup(data){
    // A tx data provided compile and render item
    $('#non-item').remove();
    var _template = _.template(tx_data_template);
    var _compiled = _template({"data":data});
    $('#tx_table_content').append(_compiled);
  }

  $(document).ready(function() {
    (function ($, localforage){
      // Set the keys on textarea onload page
      var encrypt = new JSEncrypt();
      function setKeys(){
        localforage.getItem('privatekey', function(err, value){
          $('#priv_key').val(value);
        });
        localforage.getItem('publickey', function(err, value){
          $('#pub_key').val(value);
        });

      };

      function getTxData(){
        // Render Tx Data on form
        var searchParams = new URLSearchParams(window.location.search);
        var url = window.baseurl + "api/v1/rx-endpoint/"
        if(searchParams.has("hash_id")){
          url += searchParams.get('hash_id');
          $.get(url, function(data) {
          // Get data from server
          if (data.length == 0){
            // Render no tx label
            $("#tx_table_content").html("<span id='non-item'>Without data :( Something missing!</span>");
          }else{
            data.data.forEach(function(item) {
              // Add tx to template
              add_tx_markup(item);
            });

            var color= "#fff";
            if(data.readable == true){
              color= "#d9f7ec";
            }
            else{
              color= "#f5c5d2";
            }

            $("#readable_status").html('<div id="readable_status"><p style="background-color:'+color+';color:#000">Readable: '+data.readable+'</p></div>')
          }
          console.log("Finish get!");
        });
        }
      };
      setKeys();
      getTxData();
      google.charts.setOnLoadCallback(map_test);
      google.charts.setOnLoadCallback(chart_test);

    })($, localforage);

    // Functions
    function decrypt_data(){
       // Decrypt data and create list
      var data_decrypt = [];
      var isValidData = false;
      var alert_not_found = '<div  class="uk-alert-danger" uk-alert>\
      <a class="uk-alert-close" uk-close></a>\
      <p id="alert">Error. No Private key found.</p>\
      </div>'

      if(!validate_key("#priv_key")){
        console.log("No Priv Key found");
        $('#alert').html(alert_not_found);
        document.getElementById("transferaction").disabled = true;
        return null;

      }
      else{
        

        // Make list for graph
        var index = 1;
        list_decrypt = [['Country', 'Popularity'],];
        var tx_table = $('#tx_table_content tr').children();
        var decrypt = new JSEncrypt();
        
        var privkey_encrypt =  $("#priv_key").val(); 
        var pin_flag = true;
        while (pin_flag){
          var pin_code = prompt("Please, enter your PIN CODE");
          if (pin_code.length==4){
            if (validate_pin(pin_code)){
              var privkey_decrypt = CryptoJS.AES.decrypt(privkey_encrypt, hash_string(pin_code));
              try{
                var privkey = privkey_decrypt.toString(CryptoJS.enc.Utf8);
                pin_flag = false
              }catch(err){
                alert("PIN CODE invalid");
                console.log(err);
                return null;  
              }                            
            }
          }else{
            alert("PIN CODE invalid");
            return null;
          }
        }

        decrypt.setPrivateKey(privkey);

        $.each(tx_table, function(){
          var value_input = $(this).html();
          // Decrypt data          
            $(this).html(decrypt.decrypt(value_input));
            // Create list with decrypt data
            data_decrypt.push($(this).html());
          
          
        });
        
        for (index; index<data_decrypt.length; index++){
          if (index%2){
            var percent_decrypt = 0;
            try{
                if(data_decrypt[index] == ""){
                  isValidData = false;
                  break;
                }
                percent_decrypt = parseFloat(data_decrypt[index]);
                list_decrypt.push([data_decrypt[index-1],percent_decrypt]);
                isValidData = true;
            }
            catch(err){
              isValidData = false;
              break;
            }
            
          }
        }

        if (!isValidData){
          return null;
        }
        
        // Here we enable the transfer button and disable de decrypt button
         $("#decrypt").attr("disabled", "true");
        document.getElementById("transferaction").disabled = false;
        return list_decrypt; 
      }
    }

    function draw_map(){
      // Create a map graph
      var data = google.visualization.arrayToDataTable(data_country);
      var options = {};
      var chart = new google.visualization.GeoChart(document.getElementById('regions_div'));
      chart.draw(data, options);
    }

    function draw_chart() {
      // Create a pie graph
      var data = google.visualization.arrayToDataTable(data_country);
      var options = {
        title: 'Ancestry Chart'
      };
      var chart = new google.visualization.PieChart(document.getElementById('piechart'));

      chart.draw(data, options);
    }

    function map_test(){
      // Create a map graph
      var data = google.visualization.arrayToDataTable([
        ['Country', 'Popularity'],
        ['Unknown', 0],
      ]);
      var options = {};
      var chart = new google.visualization.GeoChart(document.getElementById('regions_div'));

      chart.draw(data, options);
    }

    function chart_test(){
      // Create a pie graph
      var data = google.visualization.arrayToDataTable([
        ['Region', 'Percentage'],
        ['Unknown',     100],
      ]);
      var options = {
        title: 'Ancestry Chart'
      };
      var chart = new google.visualization.PieChart(document.getElementById('piechart'));

      chart.draw(data, options);
    }

    // Events
    $('#decrypt').on('click', function(){
      data_country = decrypt_data();
      if(data_country!=null){
        google.charts.setOnLoadCallback(draw_map);
        google.charts.setOnLoadCallback(draw_chart);
      }
      else{
        location.reload();
      }
      
    });

    document.getElementById('pubkey_file')
    .addEventListener('change', read_pubkey_file, false);

    document.getElementById("transferdata").addEventListener("click", function(event){
        transfer_data();
    });

    // Make Map, pie chart and data responsive.
    $(window).resize(function(){
      map_test();
      chart_test();
      draw_map();
      draw_chart();
    });
  });
    //Qr reader code
    $('#reader').html5_qrcode(function(data){
    /* do something when code is read */
    $('#message').html("QR found");
    $('#newpubkey').val(data);
    }, function(error){
    /* show read errors */
    $("#message").html('Unable to scan the code!')
    }, function(videoError){
    /* the video stream could be opened */
    $("#message").html('Video error');
    });
  </script>
</body>
</html>
