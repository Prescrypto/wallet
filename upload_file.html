<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Sequentia Wallet</title>
  <link rel="stylesheet" type="text/css" href="css/sequentiawallet.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/uikit/3.0.0-rc.5/css/uikit.min.css" />
  <link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,700,900" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/uikit/3.0.0-rc.5/js/uikit.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/uikit/3.0.0-rc.5/js/uikit-icons.min.js"></script>
</head>
<body>
<!-- Main menu -->
<nav class="uk-navbar-container" uk-navbar="boundary-align: true; align: right;">
  <div class="uk-navbar-left">
  	<ul class="uk-navbar-nav">
  	  <li><a class="uk-navbar-item uk-logo" href="index.html"> SequentiaWallet </a></li>
    </ul>
  </div>
  <div class="uk-navbar-right">
    <ul class="uk-navbar-nav">
      <li>
        <a class="uk-navbar-toggle" uk-navbar-toggle-icon href=""></a>
        <div class="uk-navbar-dropdown">
          <ul class="uk-nav uk-navbar-dropdown-nav">
            <li id="menu_item"><a href="https://genobank.herokuapp.com/">Go to Navigator</a></li>
            <li id="menu_item">
              <form class="uk-search uk-search-default">
                <span class="uk-search-icon-flip" uk-search-icon></span>
                <input class="uk-search-input" type="search" placeholder="Search...">
              </form>
            </li>
            <li id="menu_item"><a href="#">Contact</a></li>
          </ul>
        </div>
      </li>
    </ul>
  </div>
</nav>
<!-- Closing Main menu -->

<div id="index_content" class="uk-grid-medium" align="center">
  <h1 class="welcome">Welcome to<br>Genobank</h1>
  <p>Access your personal genomic information</p>
    <br>
  <div id="alert"></div>
  <div id="status"></div>
  <ul id="objects"></ul>
    <div class="uk-margin">
      <label class="uk-form-label" for="form-horizontal-text">Upload your file</label>
        <div class="uk-form-controls">
           <!--Upload section-->
          <div class="js-upload uk-placeholder uk-text-center">
            <span uk-icon="icon: cloud-upload"></span>
            <span class="uk-text-middle">Attach your FILE Key by dropping it here or</span>
            <div uk-form-custom>
              <input id="fileobj" type="file">
              <span id="upload_link" class="uk-link">Select your FILE from computer</span>
            </div>
          </div>
         
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/3.1.2/components/core-min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/3.1.2/components/sha256.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/3.1.2/components/enc-base64.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/3.1.2/rollups/aes.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/3.1.2/components/hmac.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/3.1.2/components/pbkdf2.js"></script>
<!--script type="text/javascript" src="https://cdn.rawgit.com/ricmoo/aes-js/e27b99df/index.js"></script-->

<script src="js/localforage.min.js"></script>
<script src="https://code.jquery.com/jquery-1.8.3.min.js"></script>
<script src="js/jsencrypt.js"></script>
<script src="js/wallet.js"></script>
<script src="https://sdk.amazonaws.com/js/aws-sdk-2.7.18.min.js"></script>




<script >
  //variables
  var alert_success = '<div  class="uk-alert-success" uk-alert>\
      <a class="uk-alert-close" uk-close></a>\
      <p id="alert">';

 var alert_error = '<div  class="uk-alert-danger" uk-alert>\
    <a class="uk-alert-close" uk-close></a>\
    <p id="alert">';
var alert_end ='</p></div>';

  var pub_key = '<Public Key>';
  var priv_key = '<PRIVATE KEY>';

  var AWS_AccessKeyId = '';
  var AWS_SecretAccessKey = '';
  var AWS_Region = 'us-west-2';  // Configure your region
  var AWS_BucketName = '';
  var AWS_MaxKeys = 500; //How many objects will retrive (include folders and items)
  var AWS_Prefix = ''; //Stating folder, by default start on root
  var AWS_SignedUrl_Expires = 900; //This is the default value for expires getSignedUrl
  var AWS_ACL = 'public-read';

  AWS.config.region = AWS_Region;
  AWS.config.update({accessKeyId: AWS_AccessKeyId, secretAccessKey: AWS_SecretAccessKey});
  var bucket = new AWS.S3({params: {Bucket: AWS_BucketName}, apiVersion: '2006-03-01'});
  // Upload
  var startTime = new Date();
  var partSize = 1024 * 1024 * 5;// Minimum 5MB per chunk (except the last part) http://docs.aws.amazon.com/AmazonS3/latest/API/mpUploadComplete.html
  var maxUploadTries = 3;
  var multipartMap = {
      Parts: []
  };
  var numPartsLeft = 0;
  var multipartResponse = null;

  
 // Functions
function completeMultipartUpload(doneParams) {
  //complete the upload of a file when we get to the end
  bucket.completeMultipartUpload(doneParams, function(err, data) {
    if (err) {
      console.log("An error occurred while completing the multipart upload");
      console.log(err);
      $('#alert').html(alert_error+'Filed on Upload '+alert_end);
    } else {
      var delta = (new Date() - startTime) / 1000;
      console.log('Completed upload in', delta, 'seconds');
      console.log('Final upload data:', data);
      $('#alert').html( alert_success+'Uploaded To: '+ data.Location + alert_end);
    }
  });
}

function uploadPart(multipart, partParams, fileKey, tryNum) {
  //upload a part from a file sliced by 5mb
    var tryNum = tryNum || 1;
    bucket.uploadPart(partParams, function(multiErr, mData) {
      if (multiErr){
        console.log('multiErr, upload part error:', multiErr);
        if (tryNum < maxUploadTries) {
          console.log('Retrying upload of part: #', partParams.PartNumber);
          uploadPart(multipart, partParams, tryNum + 1);
        } else {
          console.log('Failed uploading part: #', partParams.PartNumber);
        }
        return;
      }
      console.log(this.request.params.PartNumber);
      multipartMap.Parts[this.request.params.PartNumber - 1] = {
        ETag: mData.ETag,
        PartNumber: Number(this.request.params.PartNumber)
      };
      console.log("Completed part", this.request.params.PartNumber);
      console.log('mData', mData);
      console.log(numPartsLeft);
      if (--numPartsLeft > 0) return; // complete only when all parts uploaded

      var doneParams = {
        Bucket: AWS_BucketName,
        Key: fileKey,
        MultipartUpload: multipartMap,
        UploadId: multipart.UploadId
      };

      console.log("Completing upload...");
      completeMultipartUpload(doneParams);
    });
  }
  
  function uploadMultipart(fileName, fileData) {
    //upload a file by parts because of the size
    var fileKey = 'test/'+fileName;
    var fileLength = fileData.length;
    var partNum = 0;
    multipartMap = {
      Parts: []
    };
    numPartsLeft = Math.ceil(fileLength / partSize);
    bucket.createMultipartUpload({ Bucket: AWS_BucketName, Key: fileKey,ContentType: fileData.type, ACL:AWS_ACL }, function(mpErr, multipart) {  
      if(!mpErr){
         console.log("multipart created", multipart.UploadId);
          
          try{
            for (var rangeStart = 0; rangeStart < fileLength; rangeStart += partSize) {
              
                partNum++;
                var end = Math.min(rangeStart + partSize, fileLength);
                var partParams = { //create the part
                  Body: fileData.slice(rangeStart, end),
                  Bucket: AWS_BucketName,
                  Key: fileKey,
                  PartNumber: String(partNum),
                  UploadId: multipart.UploadId
                };

                // Send a single part
                console.log('Uploading part: #', partParams.PartNumber, ', Range start:', rangeStart);
                uploadPart(multipart, partParams, fileKey);
            }
            return true;
          }
          catch(err){
            console.log(err);
            return false;
          }
     
      }else{
        console.log(mpErr);
        return false;
      }
    });
  }

  function uploadNormal(myfile){
     // See the Configuring section to configure credentials in the SDK
    var today = new Date();
    var timestamp = today.toISOString();

    var parameters = {Key: 'test/file'+timestamp+'.txt', 
        Body: myfile,
        ContentType: myfile.type,
        ACL: AWS_ACL};
    bucket.upload(parameters, function (err, data) {
      if (err){
        console.log(err);
        $('#alert').html(alert_error+'Error on Upload!'+alert_end);
      }
     
    });
  }

 function toWordArray(str){
    //convert string to word array
        return CryptoJS.enc.Utf8.parse(str);
  }
  function toString(words){
    //convert word array to string
        return CryptoJS.enc.Utf8.stringify(words);
  }
  function toBase64String(words){
    //convert word array to string base 64
        return CryptoJS.enc.Base64.stringify(words);
  }

  function decrypt_file_symm(cipherfile, mypriv_key, mypub_key){
      // convert payload encoded in base64 to words
      var secret_key = CryptoJS.SHA256(mypriv_key);
      var iv = toWordArray(mypub_key);//CryptoJS.lib.WordArray.random(16);
      var decrypted = CryptoJS.AES.decrypt(cipherfile, secret_key, {iv: iv});

      return toString(decrypted);
  }

  function ecrypt_file_symm(myfile, mypriv_key, mypub_key){
      //encrypt file with a symmetric key
      var secret_key = CryptoJS.SHA256(mypriv_key);
      var iv = toWordArray(mypub_key);//CryptoJS.lib.WordArray.random(16);
      var encryptedfile = CryptoJS.AES.encrypt(myfile, secret_key, {iv: iv});
      // encode in base64
      return encryptedfile.toString();
  }
  function encrypt_file(myfile){
    // Encrypt data
    var encrypt = new JSEncrypt();
    var index_encrypt = 0;
    //var pub_key = $("#pubkey").val();
    encrypt.setPublicKey(pub_key);
    var encrypted_file = encrypt.encrypt(myfile);

    return encrypted_file;


  }
   function upload_file(e) {
    //uploads a file from local storage to memory

    // Variables
    var encrypted_file = null;
    var rawdata = null;
    var today = new Date();
    var timestamp = today.toISOString();
    var file = e.target.files[0];

    //Small Validation
    if (!file) {
      return;
    }

    //Read file
    var read = new FileReader();
    read.readAsText(file);
    read.onload = function(e) {
      var content = e.target.result;
      encrypted_file = ecrypt_file_symm(content, priv_key, pub_key); 

      if(encrypted_file.length > partSize){
        console.log("starting multipart upload");
        result = uploadMultipart("myfile"+timestamp+".txt", encrypted_file);
        if(result){
           $('#alert').html(alert_success+'Uploaded to: '+alert_end);
        }
        else{
            $('#alert').html(alert_error+'Filed on Upload '+alert_end);
        }
      }
      else{
        console.log("starting normal upload");
        upload_to_s3(encrypted_file);
      }
      
      $('#alert').html(alert_success+'File Loaded, waiting to Upload it...'+alert_end);

    };
    
  }

  function decrypt_from_file(e) {
    //decrypts the content of a file

    var alert_success = '<div  class="uk-alert-success" uk-alert>\
      <a class="uk-alert-close" uk-close></a>\
      <p id="alert">';

       var alert_error = '<div  class="uk-alert-danger" uk-alert>\
      <a class="uk-alert-close" uk-close></a>\
      <p id="alert">';
      var alert_end ='</p>\
      </div>';

    // Variables
    var encrypted_file = null;
    var rawdata = null;
    var today = new Date();
    var timestamp = today.toISOString();


    var file = e.target.files[0];

    //Small Validation
    if (!file) {
      return;
    }

    //Read file
    var read = new FileReader();
    read.readAsText(file);
    read.onload = function(e) {
      var content = e.target.result;
      var finali = decrypt_file_symm(content, priv_key, pub_key);
      console.log(finali);
     };
    
  }
  function compress_file(e) {
    //decrypts the content of a file

    var alert_success = '<div  class="uk-alert-success" uk-alert>\
      <a class="uk-alert-close" uk-close></a>\
      <p id="alert">';

       var alert_error = '<div  class="uk-alert-danger" uk-alert>\
      <a class="uk-alert-close" uk-close></a>\
      <p id="alert">';
      var alert_end ='</p>\
      </div>';

    // Variables
    var encrypted_file = null;
    var rawdata = null;
    var today = new Date();
    var timestamp = today.toISOString();


    var file = e.target.files[0];

    //Small Validation
    if (!file) {
      return;
    }

    //Read file
    var read = new FileReader();
    read.readAsText(file);
    read.onload = function(e) {
      var content = e.target.result;
      var level = 3;
      console.log(content);
      var out =zip_deflate(content, level);

      // out will be a JavaScript Array of bytes
      console.log(out);

     
     };
    
  }

  //event listeners
   document.getElementById('fileobj')
    .addEventListener('change', upload_file, false);



</script>
</body>
</html>